### 1.1 Getting started

Before you get started with the exercise, make sure that you load the `palmerpenguin` package and the `tidyverse` or `ggplot2`

```{r eval=FALSE}
library(palmerpenguins)
library(tidyverse)
```

To check the assumptions of linear models, we will use `performance` package. Make sure you install it once and then load it:

```{r eval=FALSE}
install.packages("performance")
library(performance)
```

The `performance` package depends on other packages as well. It might be that you encounter an error when trying to load or use it. Just read the error message and install the missing packages with `install.packages()` (likely this will be the case for the `qqplotr` package).

### 1.2 Linear regression

Make a scatter plot with bill length on the x and bill depth on the y axis.

It looks like the bill depth increases with increasing bill length. 

```{r}
g <- ggplot(penguins, aes(x = bill_length_mm, y = bill_depth_mm)) +
  geom_point()
g
```

- Fit a linear model to test this hypothesis
- Check for significant effects

```{r}
lm1 <- lm(bill_depth_mm ~ bill_length_mm, data = penguins)
drop1(lm1, test = "F")
```

- Check the model assumptions using diagnostic plots

What do you think? Are the assumptions violated or do the plots look okay?

```{r}
performance::check_model(lm1)
```

Although, the diagnostic plots do not look perfect, I would say they look good enough. However, in our case, we have measured additional variables that might help improve the model.

- How can you add the model result to the scatter plot?

```{r}
# option 1: geom_smooth
g +
  geom_smooth(se = FALSE)
```

```{r}
# option 2: extract coefficients
intercept <- lm1$coefficients[1]
slope <- lm1$coefficients[2]
g +
  geom_abline(slope = slope, intercept = intercept)
```

```{r}
# option 3: using predict (this is a bit overkill for this simple example)
pred_dat <- tibble(
  bill_length_mm = seq(from = min(penguins$bill_length_mm, na.rm = TRUE),
                       to = max(penguins$bill_length_mm, na.rm = TRUE))
)

pred_dat$bill_depth_mm <- predict(lm1, newdata = pred_dat)

g +
  geom_line(data = pred_dat, color = "cyan4")

```
### 1.3 Analysis of covariance

Does the relationship between bill length and bill depth differ between penguin species?

Add the species variable to the scatter plot from 3.1

```{r}
g2 <- ggplot(penguins, aes(x = bill_length_mm, 
                     y = bill_depth_mm,
                     color = species)) +
  geom_point()
g2
```


Now fit the linear model again, this time including species as explanatory variable.

Fit two different models:

- 1. Effect of bill length and species on bill depth *with* interaction
- 2. Effect of bill length and species on bill depth *without* interaction

```{r}
lm2a <- lm(bill_depth_mm ~ bill_length_mm + species, data = penguins)
lm2b <- lm(bill_depth_mm ~ bill_length_mm * species, data = penguins)
```

Test model assumptions for both models.

```{r}
check_model(lm2a)
check_model(lm2b)
```

Both models don't violate the assumptions for linear models and the diagnostic plots look much better than the one for the model without species.

Note that the diagnostic plots show a high collinearity between explanatory variables. This makes sense because of course the interaction between species and bill length is highly correlated with both species and bill length. However, in the case of this interaction it is not a problem, so we can ignore this.

- Check for significant effects in both models

```{r}
drop1(lm2a)
drop1(lm2b)
```

Chose the better model and plot it in the scatter plot from before.

I will choose to plot the simpler model without the interaction because the interaction between species and bill length is not significant.

To plot the model with interaction I could conveniently use `geom_smooth`

```{r}
g2 +
  geom_smooth(method = "lm", se = FALSE)
```

If I want to plot a model without interaction, I can either extract the model coefficients or use the predict function.

Extracting the model coefficients starts to become complicated, as we have 3 intercepts and 1 slope to extract:

```{r}
# option 1: extract model coefficients
intercept_adelie <- lm2a$coefficients[1]
slope <- lm2a$coefficients[2]
intercept_chinstrap <- intercept_adelie + lm2a$coefficients[3]
intercept_gentoo <- intercept_adelie + lm2a$coefficients[4]

# lets give some custom colors
cols <- c("darkorange", "cyan4", "purple")

g2 +
  geom_abline(slope = slope, intercept = intercept_adelie, color = cols[1]) +
  geom_abline(slope = slope, intercept = intercept_chinstrap, color = cols[2]) +
  geom_abline(slope = slope, intercept = intercept_gentoo, color = cols[3])+
  scale_color_manual(values = cols)

```
It is easier to use the `predict` function in this case

```{r}
pred_dat <- expand_grid(
  bill_length_mm = min(penguins$bill_length_mm, na.rm = TRUE):max(penguins$bill_length_mm, na.rm = TRUE),
  species = c("Adelie", "Chinstrap", "Gentoo")
)
pred_dat$bill_depth_mm <- predict(lm2a, newdata = pred_dat)

g2 +
  geom_line(data = pred_dat) +
  ggsci::scale_color_futurama()
```

### 1.4 Anova

Do male and female penguins differ in weight and does this depend on the species?

- Remove penguins with missing `sex` variable before you start exploring this question

```{r}
penguins_sex <- filter(penguins, !is.na(sex))
```


- Think of a plot that can represent this question

```{r}
ggplot(penguins_sex, aes(x = species, y = body_mass_g, fill = sex)) +
  geom_boxplot(notch = TRUE)
```

- Fit a linear model that represents this question

```{r}
lm3a <- lm(body_mass_g ~ sex + species, data = penguins_sex)
lm3b <- lm(body_mass_g ~ sex + species + sex:species, data = penguins_sex)
```

- Test for significant predictors

```{r}
drop1(lm3a, test = "F")
drop1(lm3b, test = "F")
```
- Test model assumptions

```{r}
check_model(lm3a)
check_model(lm3b)
```

Both look fine. Model can be used.

#### Extra

Improve the looks of the Anova result plot. You can e.g. take inspiration from the box plot in the presentation.

Have a look at `position_dodge`


```{r}
penguins_sex %>%
  ggplot(aes(x = species, 
             y = body_mass_g,
             color = sex)) +
  geom_boxplot() +
  geom_jitter(size = 3, 
              alpha = 0.25, 
              width = 0.2) +
  coord_flip() +
  ggsci::scale_color_uchicago() +
  labs(y = "Body mass [g]", x = "Species") +
  theme(legend.position = "none")

```
```{r}
penguins_sex %>%
  ggplot(aes(x = species, y = body_mass_g, color = sex)) +
  geom_jitter(size = 3, alpha = 0.25, width = 0.2) +
  ggsci::scale_color_uchicago() +
  labs(y = "Body mass [g]", x = "Species") +
  theme(legend.position = "none") +
  stat_summary(fun = mean, geom = "point", size = 5)
```

```{r}
# barplot with errorbars
```

