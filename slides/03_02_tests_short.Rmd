---
subtitle: "Introduction to R - Day "
author: "Selina Baldauf"
institute: "Freie Universit√§t Berlin - Theoretical Ecology"
date: "2021-08-01"
output:
  xaringan::moon_reader:
    seal: false
    css: [default, css/new_slides.css]
    nature:
      highlightStyle: github
      highlightLines: true
      ratio: 16:9
      countIncrementalSlides: false
      beforeInit: "macros.js"
params:
  title: "Statistical tests"
  day: "3"
  bg_image: ""
  bg_image_scale: "30%"
  bg_position: "90% 90%"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, 
  warning = FALSE, 
  message = FALSE, 
  collapse = TRUE,
  fig.height = 6.3,
  fig.allign = 'center',
  fig.retina = 3.5,
  fig.showtext = TRUE,
  error = TRUE
)
library(tidyverse)
theme_set(theme_grey(base_size=16))
options(scipen = 0)
```

```{r child="title_slide.Rmd"}

```

---
# Overview of tests

.center[![](img/day3/tests_overview.png)]

.footnote-left[Please note the discussion going on about p-values as a basis for binary decisions.
  See e.g. [here](https://www.nature.com/articles/s41592-019-0470-3) or [here](https://www.nature.com/articles/d41586-019-00857-9) as a starting point
]

---
class: inverse, center, middle

# .large[Tests for normal distribution]

---
# Test for normal distribution

There are **various tests** and the outcome might differ!

--

**Shapiro-Wilk-Test**

- How much does variance of observed data differ from normal distribution
- Specific test only for normal distribution
- High power, also for few data points

--

**Visual tests: QQ-Plot**

- Quantiles of observed data plotted against quantiles of normal distribution
- Scientist has to decide if normal or not

---
# The data

.pull-left[

Create a tibble with two variables

- `normal`: 200 normally distributed values with mean 50 and standard deviation 5
- `non_normal`: 200 uniformly distributed values between 45 and 55

```{r}
set.seed(123)
mydata <- tibble(
  normal = rnorm(
    n = 200,
    mean = 50,
    sd = 5
  ),
  non_normal = runif(
    n = 200,
    min = 45,
    max = 55
  )
)

```

]

.pull-right[
```{r echo=FALSE}
mydata %>%
  pivot_longer(cols = 1:2, names_to = "type", values_to = "value") %>%
  ggplot()+
  geom_histogram(alpha = 0.5, aes( x = value, fill = type,y = ..density..)) + # plot probability instead of count on y axis
  stat_function(fun = dnorm,
                args = list(mean = 50,
                            sd = 5),
                color = "darkorange", size = 1)+
  stat_function(fun = dnorm,
                args = list(mean = mean(mydata$non_normal),
                            sd = sd(mydata$non_normal)),
                color = "cyan4", size = 1)+
    scale_fill_manual(values = c("cyan4", "darkorange"))+
  theme(legend.position = c(0.85,0.85))
```

]

---
# Shapiro-Wilk-Test

$H_0$: Data does not differ from a normal distribution

--

.pull-left[

```{r}
shapiro.test(mydata$normal)
```

- W: test statistic
- p-value: probability to observe the data if $H_0$ was true

The data does not deviate significantly from a normal distribution (Shapiro-Wilk-Test, W = 0.991, p = 0.23).

]

--

.pull-right[
```{r}
shapiro.test(mydata$non_normal)
```

The data deviates significantly from a normal distribution (Shapiro-Wilk-Test, W = 0.95, p < 0.001).

]

---
# Visual test with QQ-Plot

Points should match the straight line. Small deviations are okay.

.pull-left[
```{r, fig.height=5.1}
# ggplot(mydata, aes(sample = normal)) +
#   stat_qq() + stat_qq_line()
ggpubr::ggqqplot(mydata$normal)
```

]
.pull-right[
```{r, fig.height=5.1}
# ggplot(mydata, aes(sample = non_normal)) +
#   stat_qq() + stat_qq_line()
ggpubr::ggqqplot(mydata$non_normal)
```

]

---
class: inverse, center, middle

# .large[Tests for equal variance]

---
# The data

```{r echo=FALSE}
InsectSprays <- InsectSprays %>%
  filter(spray %in% c("A", "B", "E")) %>%
  mutate(spray = recode(spray, "E" = "C"))
```

Counts of insects in agricultural units treated with different insecticides.

.pull-left[

Compare treatments A, B and C:

- Create subsets before: count variable for each treatment as a vector

```{r}
TreatA <- filter(InsectSprays,
                 spray == "A")$count
TreatB <- filter(InsectSprays,
                 spray == "B")$count
TreatC <- filter(InsectSprays,
                 spray == "C")$count
```


]
.pull-right[
```{r echo=FALSE, fig.height = 6.0}
ggplot(InsectSprays, aes(x=spray, y=count, fill = spray))+
  geom_boxplot(notch=TRUE)+
  theme(legend.position = "none")
```
]

---
# Test for equal variance

First, test for normal distribution!

**F-Test**

- **Normal distribution** of groups
- Calculates ratio of variances (if equal, ratio = 1)
- p: How likely is ratio if variances were equal?

**Levene test**

- **Non-normal distribution** of groups
- Compare difference between data sets with difference within data sets

---
# Test for equal variances

If we want to compare variances between treatments A, B and C, we first test for normal distribution

```{r}
shapiro.test(TreatA)
shapiro.test(TreatB)
shapiro.test(TreatC)
```

Result: All 3 treatments are normally distributed.

---
# F-Test

$H_0$: Variances do not differ between groups

--

```{r error=TRUE}
var.test(TreatA, TreatB)
```

--

- F: test statistics, ratio of variances (if F = 1, variances are equal)
- df: degrees of freedom of both groups
- p-value: how likely is it to observe the data if $H_0$ was true?

Result: The variances of sprays A and B do not differ significantly (F-Test, $F_{11,11}$ = 1.22, p = 0.75)

---
# F-Test

$H_0$: Variances do not differ between groups

--

```{r error=TRUE}
var.test(TreatA, TreatC)
```

Result: The variances of sprays A and C differ significantly (F-Test, $F_{11,11}$ = 7.42, p = 0.002)

---
class: inverse, center, middle

# .large[Test for equal means]

---
# Test for equal means

**t-test**

- **Normal distribution** AND **equal variance**
- Compares if mean values are within range of standard error of each other
- p: how likely is the difference if the means were equal

--

**Welch-Test**

- **Normal distribution** but **unequal variance**
- Corrected t-test

--

.pull-left[

**Wilcoxon rank sum test**

- **Non-normal distribution** and **unequal variance**
- Compares rank sums of the data
- Non-parametric

]
.pull-right[
<br>
![](img/day3/wilcoxon.png)]

---
# t-test

$H_0$: The samples do not differ in their mean

--

Treatment A and B: **normally distributed** and **equal variance**

```{r}
t.test(TreatA, TreatB, var.equal = TRUE)
```

- t: test statistics (t = 0 means equal means)
- df: degrees of freedom of t-statistics
- p-value: how likely is it to observe the data if $H_0$ was true?

--

**Result:** The means of spray A and B do not differ significantly (t = -0.45, df = 22, p = 0.66)

---
# Welch-Test

$H_0$: The samples do not differ in their mean

--

Treatment A and C: **normally distributed** and **non-equal variance**

```{r}
t.test(TreatA, TreatC, var.equal = FALSE)
```

--

**Result:** The means of spray A and C do differ significantly (t = 7.58, df = 13.9, p < 0.001)

---
# Wilcoxon-rank-sum Test

$H_0$: The samples do not differ in their mean

--

We don't need the Wilcoxon test to compare treatment A and B, but for the sake of an example:

```{r}
wilcox.test(TreatA, TreatB)
```
--

**Result:** The means of spray A and B do not differ significantly (W = 62, p = 0.58)

---
# Paired values

Are there pairs of data points?

**Example: ** samples of invertebrates across various rivers before and after sewage plants.

- For each plant, there is a pair of data points (before and after the plant)
- Question: Is the change (before-after) significant

Use `paired = TRUE` in the test.

```{r eval=FALSE}
t.test(TreatA, TreatB, var.equal = TRUE, paired = TRUE)
t.test(TreatA, TreatB, var.equal = FALSE, paired = TRUE)
wilcox.test(TreatA, TreatB, paired = TRUE)

```

Careful: your treatment vector both have to have the same order

---
# Plot test results with `ggsignif`

The [`ggsignif`](https://const-ae.github.io/ggsignif/) package offers a `geom_signif()`
layer that can be added to a ggplot to annotate significance levels

```{r eval=FALSE}
# install.packages("ggsignif")
library(ggsignif)
```

---
# Plot test results with `geom_signif()`

.pull-left[

```{r eval=FALSE}
ggplot(InsectSprays, 
       aes(x = spray, y = count)) +
  geom_boxplot(notch = TRUE) +
  geom_signif( #<<
    comparisons = list( #<<
      c("A", "B"),#<<
      c("B", "C"),#<<
      c("A", "C")#<<
    ),#<<
    map_signif_level = TRUE,#<<
    y_position = c(23,24,25)#<<
  )
```

- By default, a Wilcoxon test is performed

]

.pull-right[

```{r echo = FALSE}
ggplot(InsectSprays, 
       aes(x = spray, y = count)) +
  geom_boxplot(notch = TRUE) +
  ggsignif::geom_signif( #<<
    comparisons = list( #<<
      c("A", "B"),#<<
      c("B", "C"),#<<
      c("A", "C")#<<
    ),#<<
    map_signif_level = TRUE,#<<
    y_position = c(23,24,25)#<<
  ) #<<
```

]


---
# Plot test results with `geom_signif()`

.pull-left[

```{r eval=FALSE}
ggplot(InsectSprays, 
       aes(x = spray, y = count)) +
  geom_boxplot(notch = TRUE) +
  geom_signif( 
    comparisons = list( 
      c("A", "B"),
      c("B", "C"),
      c("A", "C")
    ),
    test = "t.test",#<<
    test.args = list( #<<
      var.equal = TRUE#<<
    ),#<<
    map_signif_level = TRUE,
    y_position = c(23,24,25)
  )
```

- Specify a specific test with the `test` argument
- Additional arguments can be passed as a list with the `test.args` argument
- Look at `?geom_signif` for more options

]

.pull-right[

```{r echo = FALSE}
ggplot(InsectSprays, aes(x = spray, y = count)) +
  geom_boxplot(notch = TRUE) +
  ggsignif::geom_signif( #<<
    comparisons = list( #<<
      c("A", "B"),#<<
      c("B", "C"),#<<
      c("A", "C")#<<
    ),#<<
    test = "t.test",#<<
    test.args = list(
      var.equal = TRUE
    ),
    map_signif_level = TRUE,#<<
    y_position = c(23,24,25)#<<
  )
```

]


---
# Plot mean +- se using `stat_summary`

Another way to plot the results is to plot mean and standard error of the mean:

.pull-left[

```{r eval = FALSE}
ggplot(
  InsectSprays,
  aes(x = spray, y = count)
) +
  stat_summary() #<<
```

- By default `stat_summary` adds mean and standard error of the mean as pointrange

]


.pull-right[

```{r echo = FALSE}
ggplot(
  InsectSprays,
  aes(x = spray, y = count)
) +
  stat_summary()
```

]

---
# Plot mean +- se using `stat_summary`

Another way to plot the results is to plot mean and standard error of the mean:

.pull-left[

```{r eval = FALSE}
ggplot(InsectSprays, aes(x = spray, y = count)) +
  stat_summary(
    fun.data = mean_se,
    geom = "errorbar"
  ) +
  stat_summary(
    fun.y = mean,
    geom = "point",
    color = "#28a87d",
    size = 4
  )
```

- Inside `stat_summary`, you can define function used to calculate the summary
  - `fun.data` for errorbars
  - `fun.y` for point values (e.g. mean)
- Define the geom that represents the summary

]


.pull-right[

```{r echo = FALSE}
ggplot(InsectSprays, aes(x = spray, y = count)) +
  stat_summary(
    fun.data = mean_se,
    geom = "errorbar"
  ) +
  stat_summary(
    fun.y = mean,
    geom = "point",
    color = "#28a87d",
    size = 4
  )
```

]

---
# Plot mean +- se using `stat_summary`

Another way to plot the results is to plot mean and standard error of the mean:

.pull-left[

```{r eval = FALSE}
ggplot(InsectSprays, aes(x = spray, y = count)) +
  stat_summary(
    fun.data = mean_se,
    geom = "errorbar",
    width = 0.3
  ) +
  stat_summary(
    fun.y = mean,
    geom = "bar", #<<
    size = 4
  )
```

]


.pull-right[

```{r echo = FALSE}
ggplot(InsectSprays, aes(x = spray, y = count)) +
  stat_summary(
    fun.data = mean_se,
    geom = "errorbar",
    width = 0.3
  ) +
  stat_summary(
    fun.y = mean,
    geom = "bar", #<<
    size = 4
  )
```

]

---
# Plot mean +- se using `stat_summary`

Just like before, you can also add a `geom_signif` to a barplot:

.pull-left[

```{r eval = FALSE}
ggplot(InsectSprays, aes(x = spray, y = count)) +
  stat_summary(
    fun.data = mean_se,
    geom = "errorbar",
    width = 0.3
  ) +
  stat_summary(
    fun.y = mean,
    geom = "bar"
  )+
  ggsignif::geom_signif(
    comparisons = list(
      c("A", "B"),
      c("B", "C"),
      c("A", "C")
    ),
    test = "t.test",
    map_signif_level = TRUE,
    y_position = c(17,18,19)
  )
```

]


.pull-right[

```{r echo = FALSE}
ggplot(InsectSprays, aes(x = spray, y = count)) +
  stat_summary(
    fun.data = mean_se,
    geom = "errorbar",
    width = .3
  ) +
  stat_summary(
    fun.y = mean,
    geom = "bar"
  )+
  ggsignif::geom_signif(
    comparisons = list(
      c("A", "B"),
      c("B", "C"),
      c("A", "C")
    ),
    test = "t.test",
    map_signif_level = TRUE,
    y_position = c(17,18,19)
  )
```

]


---
class: inverse, middle, center

# .large[Now you]

## Task 1: Statistical tests (45 min)

#### Find the task description [here](https://selinazitrone.github.io/intro-r-data-analysis/03_tasks_controller.html#statistical-tests)

